
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dashboard.css">
    <title>Admin Dashboard</title>
    <script>
        // Security check: Redirect to login if not an admin
        if (localStorage.getItem('role') !== 'admin') {
            window.location.href = 'admin-login.html';
        }
    </script>
    <style>
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1.05rem;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .tab-button:hover {
            background-color: #f7f7f7;
            color: #002366;
        }
        .tab-button.active {
            color: #002366;
            border-bottom-color: #FFD700;
            font-weight: 700;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #welcome h2 {
            color: #002366;
            font-weight: 700;
        }
        #welcome p {
            color: #333;
            font-size: 1.1rem;
        }
        #reader { width: 100%; max-width: 500px; margin: 20px auto; border: 2px solid #f0f0f0; border-radius: 8px; }
        #result-container { margin-top: 20px; }
        .result-card { padding: 20px; border-radius: 8px; text-align: center; }
        .result-valid { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result-invalid { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .student-details { text-align: left; margin-top: 15px; }
        .instructions {
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #FFD700;
            color: #333;
        }
        .instructions h4 {
            margin-top: 0;
            color: #002366;
        }
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="cavendish-logo.png" alt="Cavendish University Logo" class="logo">
            <h1>Admin Dashboard</h1>
        </div>
        <button id="logoutBtn">Logout</button>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('welcome')">Welcome</button>
            <button class="tab-button" onclick="openTab('payments')">Update Payments</button>
            <button class="tab-button" onclick="openTab('verify')">Verify Docket</button>
        </div>

        <div id="welcome" class="tab-content active">
            <h2>Welcome, Admin!</h2>
            <p>This is your central hub for managing student dockets. Please select a tab to get started.</p>
        </div>

        <div id="payments" class="tab-content">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search by name or student number...">
                <button id="searchBtn">Search</button>
            </div>
            <div id="results-container">
                <!-- Search results will be displayed here -->
            </div>
        </div>

        <div id="verify" class="tab-content">
            <div class="instructions">
                <h4>Scanning Instructions</h4>
                <ul>
                    <li>Position the docket's QR code clearly within the camera frame.</li>
                    <li>Ensure good lighting and a steady hand for a quick scan.</li>
                    <li>After scanning, cross-reference the student's details on the screen with their ID.</li>
                    <li>Report any discrepancies or invalid dockets to the registrar immediately.</li>
                </ul>
            </div>
            <h2 style="text-align: center;">Point Camera at Docket QR Code</h2>
            <div id="reader"></div>
            <div id="result-container" style="text-align: center;">
                <p>Waiting for scan...</p>
            </div>
        </div>
    </main>

    <!-- QR Code Scanning Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        const token = localStorage.getItem("token");

        function openTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'verify') {
                startScanner();
            } else {
                stopScanner();
            }
        }

        // Payments tab script
        document.getElementById("searchBtn").onclick = async () => {
            const query = document.getElementById("search-input").value;
            if (!query) {
                return;
            }

            const resultsContainer = document.getElementById("results-container");
            resultsContainer.innerHTML = "<p>Loading...</p>";

            try {
                const res = await fetch(`/dockets/students/search?q=${query}`, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
                const json = await res.json();

                if (json.ok) {
                    const students = json.students;
                    resultsContainer.innerHTML = "";
                    if (students.length === 0) {
                        resultsContainer.innerHTML = "<p>No students found.</p>";
                    } else {
                        students.forEach(student => {
                            const studentCard = document.createElement("div");
                            studentCard.className = "student-card";
                            studentCard.innerHTML = `
                                <div class="student-info">
                                    <h3>${student.first_name} ${student.last_name}</h3>
                                    <p><strong>Student Number:</strong> ${student.student_number}</p>
                                    <p><strong>Programme:</strong> ${student.programme_name}</p>
                                </div>
                                <div class="balance-info">
                                    <p><strong>Total Fee:</strong> ${student.total_fee}</p>
                                    <p><strong>Amount Paid:</strong> ${student.amount_paid}</p>
                                    <p><strong>Balance:</strong> ${student.balance}</p>
                                </div>
                                <div class="payment-form">
                                    <h4>Update Payment</h4>
                                    <input type="number" id="amount-${student.student_number}" placeholder="Amount">
                                    <button onclick="updatePayment('${student.student_number}')">Update Payment</button>
                                </div>
                            `;
                            resultsContainer.appendChild(studentCard);
                        });
                    }
                } else {
                    resultsContainer.innerHTML = `<p>Error: ${json.error || "Unknown error"}</p>`;
                }
            } catch (err) {
                console.error("Error searching students:", err);
                resultsContainer.innerHTML = "<p>An error occurred while searching.</p>";
            }
        };

        async function updatePayment(student_number) {
            const amount = document.getElementById(`amount-${student_number}`).value;
            if (!amount) {
                alert("Please enter an amount.");
                return;
            }

            try {
                const res = await fetch("/dockets/payments/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_number: student_number,
                        amount: amount
                    })
                });

                const json = await res.json();

                if (json.ok) {
                    alert("Payment updated successfully!");
                    document.getElementById("searchBtn").click(); // Refresh search results
                } else {
                    alert("Failed to update payment: " + (json.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error updating payment:", err);
                alert("An error occurred while updating the payment.");
            }
        }

        // Verify docket tab script
        const resultContainer = document.getElementById("result-container");
        let html5QrcodeScanner;

        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            stopScanner();
            resultContainer.innerHTML = "<p>Verifying...</p>";

            try {
                const res = await fetch("/verification/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ qr_data: decodedText })
                });

                const json = await res.json();
                let resultHtml = "";

                if (json.ok) {
                    const student = json.student;
                    resultHtml = `
                        <div class="result-card result-valid">
                            <h2>DOCKET VALID</h2>
                            <div class="student-details">
                                <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                                <p><strong>Student Number:</strong> ${student.student_number}</p>
                                <p><strong>Programme:</strong> ${student.programme_name}</p>
                                <p><strong>Exam Type:</strong> ${json.exam_type.toUpperCase()}</p>
                            </div>
                        </div>
                    `;
                } else {
                    resultHtml = `
                        <div class="result-card result-invalid">
                            <h2>DOCKET INVALID</h2>
                            <p>${json.error || "Verification failed."}</p>
                        </div>
                    `;
                }
                resultContainer.innerHTML = resultHtml;

            } catch (err) {
                console.error("Verification failed:", err);
                resultContainer.innerHTML = '<div class="result-card result-invalid"><h3>An unexpected error occurred.</h3></div>';
            }
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`);
        }

        function startScanner() {
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", 
                    { fps: 10, qrbox: {width: 250, height: 250} },
                    false);
            }
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.clear();
                } catch (e) {
                    console.error("Failed to clear scanner:", e);
                }
            }
        }

        // Logout script
        document.getElementById("logoutBtn").onclick = async () => {
            try {
                await fetch("/logout", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    credentials: "include"
                });
            } catch (err) {
                console.error("Error during logout:", err);
            } finally {
                localStorage.removeItem("token");
                localStorage.removeItem("role");
                window.location.href = "admin-login.html";
            }
        };
    </script>
</body>
</html>
