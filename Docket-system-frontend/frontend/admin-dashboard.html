<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dashboard.css">
    <title>Admin Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <script>
        if (localStorage.getItem('role') !== 'admin') {
            window.location.href = 'admin-login.html';
        }
    </script>
    <style>
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-button {
            background: none; border: none; padding: 1rem 1.5rem; cursor: pointer;
            font-size: 1.05rem; color: #555; border-bottom: 3px solid transparent;
            transition: all 0.3s ease; font-weight: 500;
        }
        .tab-button:hover { background-color: #f7f7f7; color: #002366; }
        .tab-button.active { color: #002366; border-bottom-color: #FFD700; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #welcome h2 { color: #002366; font-weight: 700; }
        #welcome p { color: #333; font-size: 1.1rem; }
        #reader { width: 100%; max-width: 500px; margin: 20px auto; border: 2px solid #f0f0f0; border-radius: 8px; }
        #result-container { margin-top: 20px; }
        .result-card { padding: 20px; border-radius: 8px; text-align: center; }
        .result-valid { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result-invalid { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .student-details { text-align: left; margin-top: 15px; }
        .instructions { max-width: 500px; margin: 20px auto; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #FFD700; color: #333; }
        .instructions h4 { margin-top: 0; color: #002366; }
        .instructions ul { padding-left: 20px; margin-bottom: 0; }
        .instructions li { margin-bottom: 8px; }
        .settings-card { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 2rem auto; }
        .settings-card h3 { color: #002366; margin-top: 0; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .form-group input[type="radio"] { margin-right: 0.5rem; }
        .save-btn { background-color: #002366; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .docket-controls { border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem; }
        .docket-controls .status { font-weight: bold; }
        .docket-controls .status-blocked { color: #dc3545; }
        .docket-controls .status-active { color: #28a745; }
        .block-btn, .unblock-btn { width: 100%; border: none; padding: 0.75rem; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 0.5rem; }
        .block-btn { background-color: #dc3545; color: white; }
        .unblock-btn { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="cavendish-logo.png" alt="Cavendish University Logo" class="logo">
            <h1>Admin Dashboard</h1>
        </div>
        <button id="logoutBtn">Logout</button>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'welcome')">Welcome</button>
            <button class="tab-button" onclick="openTab(event, 'payments')">Student Management</button>
            <button class="tab-button" onclick="openTab(event, 'controls')">Docket Controls</button>
            <button class="tab-button" onclick="openTab(event, 'verify')">Verify Docket</button>
        </div>

        <div id="welcome" class="tab-content active">
            <h2>Welcome, Admin!</h2>
            <p>Use the tabs to manage student payments, control docket access, and verify dockets.</p>
        </div>

        <div id="payments" class="tab-content">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search by name or student number...">
                <button id="searchBtn">Search</button>
            </div>
            <div id="results-container"><!-- Search results will be displayed here --></div>
        </div>

        <div id="controls" class="tab-content">
            <div class="settings-card">
                <h3>Active Docket Settings</h3>
                <div class="form-group">
                    <label>Select the only docket type that eligible students can currently print:</label>
                    <div>
                        <input type="radio" id="exam_ca1" name="active_exam" value="ca1"><label for="exam_ca1"> CA 1</label><br>
                        <input type="radio" id="exam_ca2" name="active_exam" value="ca2"><label for="exam_ca2"> CA 2</label><br>
                        <input type="radio" id="exam_exam" name="active_exam" value="exam"><label for="exam_exam"> Final Exam</label><br>
                    </div>
                </div>
                <button class="save-btn" onclick="saveExamSettings()">Save Settings</button>
            </div>
        </div>

        <div id="verify" class="tab-content">
            <div class="instructions">
                <h4>Scanning Instructions</h4>
                <ul>
                    <li>Position the docket's QR code clearly within the camera frame.</li>
                    <li>Ensure good lighting and a steady hand for a quick scan.</li>
                    <li>After scanning, cross-reference the student's details on the screen with their ID.</li>
                    <li>Report any discrepancies or invalid dockets to the registrar immediately.</li>
                </ul>
            </div>
            <h2 style="text-align: center;">Point Camera at Docket QR Code</h2>
            <div id="reader"></div>
            <div id="result-container" style="text-align: center;">
                <p>Waiting for scan...</p>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="db.js"></script>

    <script>
        const token = localStorage.getItem("token");
        let blockedStudentsList = [];

        async function syncDataForOfflineUse() {
            console.log("Starting offline data synchronization...");
            try {
                const headers = { "Authorization": `Bearer ${token}` };
                
                // Sync students
                const studentsRes = await fetch('/dockets/sync/students', { headers });
                if (studentsRes.ok) {
                    const studentsData = await studentsRes.json();
                    await clearAndAddData('students', studentsData.students);
                    console.log('Successfully synced students to IndexedDB.');
                }

                // Sync active docket tokens
                const tokensRes = await fetch('/dockets/sync/tokens', { headers });
                if (tokensRes.ok) {
                    const tokensData = await tokensRes.json();
                    // We need to store objects in IndexedDB, so we map the array of strings
                    const tokenObjects = tokensData.tokens.map(hash => ({ token_hash: hash }));
                    await clearAndAddData('active_dockets', tokenObjects);
                    console.log('Successfully synced active dockets to IndexedDB.');
                }

                // Sync blocked students
                const blockedRes = await fetch('/admin/blocked-students', { headers });
                if (blockedRes.ok) {
                    const blockedData = await blockedRes.json();
                    // We need to store objects in IndexedDB
                    const blockedObjects = blockedData.blocked_students.map(num => ({ student_number: num }));
                    await clearAndAddData('blocked_students', blockedObjects);
                    console.log('Successfully synced blocked students to IndexedDB.');
                }
                alert('Offline data synced successfully!');
            } catch (err) {
                console.error("Offline sync failed:", err);
                alert("Could not sync offline data. Verification will only work online.");
            }
        }

        async function loadAdminControlsData() {
            try {
                const [settingsRes, blockedRes] = await Promise.all([
                    fetch('/admin/settings', { headers: { "Authorization": `Bearer ${token}` } }),
                    fetch('/admin/blocked-students', { headers: { "Authorization": `Bearer ${token}` } })
                ]);

                if (settingsRes.ok) {
                    const settingsJson = await settingsRes.json();
                    const activeExam = settingsJson.settings.active_exam;
                    const radioBtn = document.querySelector(`input[name='active_exam'][value='${activeExam}']`);
                    if (radioBtn) {
                        radioBtn.checked = true;
                    }
                }

                if (blockedRes.ok) {
                    const blockedJson = await blockedRes.json();
                    blockedStudentsList = blockedJson.blocked_students || [];
                }
            } catch (err) {
                console.error("Error loading admin data:", err);
                alert("Could not load admin settings. Please refresh.");
            }
        }

        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'verify') startScanner(); else stopScanner();
        }

        document.getElementById("searchBtn").onclick = async () => {
            const query = document.getElementById("search-input").value;
            if (!query) return;

            const resultsContainer = document.getElementById("results-container");
            resultsContainer.innerHTML = "<p>Loading...</p>";

            try {
                const res = await fetch(`/dockets/students/search?q=${query}`, { headers: { "Authorization": `Bearer ${token}` } });
                const json = await res.json();

                if (json.ok) {
                    resultsContainer.innerHTML = "";
                    if (json.students.length === 0) {
                        resultsContainer.innerHTML = "<p>No students found.</p>";
                        return;
                    }
                    json.students.forEach(student => {
                        const isBlocked = blockedStudentsList.includes(student.student_number);
                        const studentCard = document.createElement("div");
                        studentCard.className = "student-card";
                        studentCard.innerHTML = `
                            <div class="student-info">
                                <h3>${student.first_name} ${student.last_name}</h3>
                                <p><strong>Student Number:</strong> ${student.student_number}</p>
                                <p><strong>Programme:</strong> ${student.programme_name}</p>
                            </div>
                            <div class="balance-info">
                                <p><strong>Total Fee:</strong> ${student.total_fee}</p>
                                <p><strong>Amount Paid:</strong> ${student.amount_paid}</p>
                                <p><strong>Balance:</strong> ${student.balance}</p>
                            </div>
                            <div class="payment-form">
                                <h4>Update Payment</h4>
                                <input type="number" id="amount-${student.student_number}" placeholder="Amount">
                                <button onclick="updatePayment('${student.student_number}')">Update Payment</button>
                            </div>
                            <div class="docket-controls">
                                <h4>Docket Status</h4>
                                <p>Status: <span class="status ${isBlocked ? 'status-blocked' : 'status-active'}">${isBlocked ? 'BLOCKED' : 'Active'}</span></p>
                                ${isBlocked ? 
                                    `<button class="unblock-btn" onclick="unblockStudent('${student.student_number}')">Unblock Student</button>` : 
                                    `<button class="block-btn" onclick="blockStudent('${student.student_number}')">Block Student</button>`
                                }
                            </div>
                        `;
                        resultsContainer.appendChild(studentCard);
                    });
                } else {
                    resultsContainer.innerHTML = `<p>Error: ${json.error || "Unknown error"}</p>`;
                }
            } catch (err) {
                console.error("Error searching students:", err);
                resultsContainer.innerHTML = "<p>An error occurred while searching.</p>";
            }
        };

        async function updatePayment(student_number) { 
            const amount = document.getElementById(`amount-${student_number}`).value;
            if (!amount) {
                alert("Please enter an amount.");
                return;
            }

            try {
                const res = await fetch("/dockets/payments/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_number: student_number,
                        amount: amount
                    })
                });

                const json = await res.json();

                if (json.ok) {
                    alert("Payment updated successfully!");
                    document.getElementById("searchBtn").click(); // Refresh search results
                } else {
                    alert("Failed to update payment: " + (json.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error updating payment:", err);
                alert("An error occurred while updating the payment.");
            }
        }

        async function saveExamSettings() {
            const checkedRadio = document.querySelector('input[name="active_exam"]:checked');
            if (!checkedRadio) {
                alert("Please select an exam type.");
                return;
            }
            const activeExam = checkedRadio.value;
            try {
                const res = await fetch('/admin/settings', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ active_exam: activeExam })
                });
                if (res.ok) {
                    alert("Settings saved successfully!");
                } else {
                    const json = await res.json();
                    alert("Error saving settings: " + (json.error || "Unknown error"));
                }
            } catch (err) {
                alert("An error occurred while saving settings.");
            }
        }

        async function blockStudent(studentNumber) {
            if (!confirm(`Are you sure you want to block all dockets for ${studentNumber}?`)) return;
            try {
                const res = await fetch(`/admin/students/${studentNumber}/block`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    alert("Student blocked successfully.");
                    await loadAdminControlsData(); // Refresh blocklist
                    document.getElementById("searchBtn").click(); // Refresh search results
                } else { alert("Failed to block student."); }
            } catch (err) { alert("An error occurred."); }
        }

        async function unblockStudent(studentNumber) {
            if (!confirm(`Are you sure you want to unblock all dockets for ${studentNumber}?`)) return;
            try {
                const res = await fetch(`/admin/students/${studentNumber}/unblock`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    alert("Student unblocked successfully.");
                    await loadAdminControlsData(); // Refresh blocklist
                    document.getElementById("searchBtn").click(); // Refresh search results
                } else { alert("Failed to unblock student."); }
            } catch (err) { alert("An error occurred."); }
        }

        const resultContainer = document.getElementById("result-container");
        let html5QrcodeScanner;
        let isScanProcessing = false;

        function addPendingVerification(qrData) {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onsuccess = event => {
                const db = event.target.result;
                const transaction = db.transaction(['pending_verifications'], 'readwrite');
                const store = transaction.objectStore('pending_verifications');
                store.add({ qr_data: qrData, timestamp: new Date().toISOString() });
            };
        }

        async function onScanSuccess(decodedText, decodedResult) {
            if (isScanProcessing) return;
            isScanProcessing = true;
            resultContainer.innerHTML = "<p>Verifying...</p>";

            const isOnline = navigator.onLine;

            try {
                // OFFLINE-FIRST LOGIC
                const db = await openDB();
                const parts = decodedText.split('|');
                if (parts.length !== 3) throw new Error("Invalid QR format");
                const [student_number, exam_type, token_value] = parts;
                const token_hash = await sha256(token_value);

                const blockedTx = db.transaction(['blocked_students'], 'readonly');
                const blockedStore = blockedTx.objectStore('blocked_students');
                const blockedReq = blockedStore.get(student_number);

                blockedReq.onsuccess = async () => {
                    if (blockedReq.result) {
                        displayResult(false, { error: "Student is blocked." });
                        return;
                    }

                    const docketTx = db.transaction(['active_dockets'], 'readonly');
                    const docketStore = docketTx.objectStore('active_dockets');
                    const docketReq = docketStore.get(token_hash);

                    docketReq.onsuccess = async () => {
                        if (docketReq.result) {
                            // Local verification success
                            const studentTx = db.transaction(['students'], 'readonly');
                            const studentStore = studentTx.objectStore('students');
                            const studentReq = studentStore.get(student_number);

                            studentReq.onsuccess = () => {
                                displayResult(true, { student: studentReq.result, exam_type: exam_type });
                                // Remove from local active dockets and add to pending sync
                                const delTx = db.transaction(['active_dockets'], 'readwrite');
                                delTx.objectStore('active_dockets').delete(token_hash);
                                addPendingVerification(decodedText);
                                navigator.serviceWorker.ready.then(swRegistration => swRegistration.sync.register('sync-pending-verifications'));
                            };
                        } else {
                            // Not found locally, fallback to online if possible
                            if (isOnline) {
                                fetchOnline(decodedText);
                            } else {
                                displayResult(false, { error: "Docket not found in offline data." });
                            }
                        }
                    };
                };

            } catch (err) {
                if (isOnline) fetchOnline(decodedText); // Fallback on any error if online
                else displayResult(false, { error: "Verification failed offline." });
            }
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function displayResult(ok, data) {
            let resultHtml = "";
            if (ok) {
                const student = data.student;
                resultHtml = `
                    <div class="result-card result-valid">
                        <h2>DOCKET VALID</h2>
                        <div class="student-details">
                            <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                            <p><strong>Student Number:</strong> ${student.student_number}</p>
                            <p><strong>Programme:</strong> ${student.programme_name}</p>
                            <p><strong>Exam Type:</strong> ${data.exam_type.toUpperCase()}</p>
                        </div>
                    </div>
                `;
            } else {
                resultHtml = `
                    <div class="result-card result-invalid">
                        <h2>DOCKET INVALID</h2>
                        <p>${data.error || "Verification failed."}</p>
                    </div>
                `;
            }
            resultContainer.innerHTML = resultHtml;
            setTimeout(() => {
                isScanProcessing = false;
                resultContainer.innerHTML = "<p>Waiting for scan...</p>";
            }, 15000);
        }

        async function fetchOnline(qrData) {
            try {
                const res = await fetch("/verification/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ qr_data: qrData })
                });
                const json = await res.json();
                displayResult(json.ok, json);
            } catch (err) {
                displayResult(false, { error: "Online verification failed." });
            }
        }

        function onScanFailure(error) { }

        function startScanner() {
            document.getElementById('reader').style.display = 'block'; // Show the reader
            if (!html5QrcodeScanner || !html5QrcodeScanner.isScanning) {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            }
        }

        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                try {
                    html5QrcodeScanner.clear();
                } catch (e) {
                    console.error("Failed to clear scanner:", e);
                }
            }
            document.getElementById('reader').style.display = 'none'; // Hide the reader
        }

        document.getElementById("logoutBtn").onclick = () => {
            localStorage.removeItem("token");
            localStorage.removeItem("role");
            window.location.href = "admin-login.html";
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminControlsData();
            syncDataForOfflineUse();
        });
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
</body>
</html>