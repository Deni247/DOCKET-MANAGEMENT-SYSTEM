<!DOCTYPE html>
<html>
<head>
  <title>Dockets</title>
  <link rel="stylesheet" href="dashboard.css">
  <script>
      // Security check: Redirect to login if no session is found
      if (!localStorage.getItem('student_id')) {
          window.location.href = 'students-portal.html';
      }
  </script>
</head>
<body>
  <div class="sidebar">
    <a href="dashboard.html">Home</a>
    <a href="dockets.html" class="active">Dockets</a>
    <a href="payments.html">Payments</a>
    <a href="results.html">Results</a>
  </div>

  <div class="header">
    <img src="cavendish-logo.png" alt="Cavendish Logo" class="logo">
    <h1>Dockets</h1>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>

  <div class="main">
    <h2>Your Exam Dockets</h2>
    <div id="docketSection">Loading eligibility...</div>
  </div>

<script>
async function loadDockets() {
  const student_id = localStorage.getItem("student_id");
  // The security check at the top already handles the case where student_id is null

  try {
    const res = await fetch(`/dockets/eligibility/${student_id}`);
    const json = await res.json();

    if (!json.ok) {
      // If token is invalid or expired, the API returns an error. Redirect to login.
      if (res.status === 401) {
          window.location.href = 'students-portal.html';
          return;
      }
      document.getElementById("docketSection").innerText = json.error || "Error fetching eligibility.";
      return;
    }

    let html = "<table border='1' cellpadding='10'><tr><th>Exam Type</th><th>Status</th><th>Action</th></tr>";
    json.eligibility.forEach(e => {
      const btn = e.eligible
        ? `<button onclick="previewDocket('${e.exam_type}')">Preview & Download</button>`
        : `<span style='color:red'>Please visit Retentions Office</span>`;
      html += `<tr><td>${e.exam_type.toUpperCase()}</td><td>${e.eligible ? "Eligible" : "Not Eligible"}</td><td>${btn}</td></tr>`;
    });
    html += "</table>";
    document.getElementById("docketSection").innerHTML = html;
  } catch (error) {
    console.error('Error fetching dockets:', error);
    document.getElementById("docketSection").innerText = "An error occurred while fetching dockets.";
  }
}

function previewDocket(exam_type) {
  const student_id = localStorage.getItem("student_id");
  const previewUrl = `docket-preview.html?student_id=${student_id}&exam_type=${exam_type}`;
  window.open(previewUrl, '_blank');
}

document.getElementById("logoutBtn").onclick = async () => {
    // No need to call a /logout endpoint if just clearing client-side session
    localStorage.clear();
    window.location.href = "students-portal.html";
};

loadDockets();
</script>
</body>
</html>

