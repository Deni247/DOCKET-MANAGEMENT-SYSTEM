<!DOCTYPE html>
<html>
<head>
  <title>Dockets</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="sidebar">
    <a href="dashboard.html">Home</a>
    <a href="dockets.html" class="active">Dockets</a>
    <a href="payments.html">Payments</a>
    <a href="results.html">Results</a>
  </div>

  <div class="header">
    <img src="cavendish-logo.png" alt="Cavendish Logo" class="logo">
    <h1>Dockets</h1>
    <a href="dashboard.html"><button class="logout">Back</button></a>
  </div>

  <div class="main">
    <h2>Your Exam Dockets</h2>
    <div id="docketSection">Loading eligibility...</div>
  </div>

<script>
async function loadDockets() {
  const student_id = localStorage.getItem("student_id");
  if (!student_id) {
    document.getElementById("docketSection").innerText = "No student session found.";
    return;
  }

  const res = await fetch(`http://127.0.0.1:5000/dockets/eligibility/${student_id}`);
  const json = await res.json();

  if (!json.ok) {
    document.getElementById("docketSection").innerText = json.error || "Error fetching eligibility.";
    return;
  }

  let html = "<table border='1' cellpadding='10'><tr><th>Exam Type</th><th>Status</th><th>Action</th></tr>";
  json.eligibility.forEach(e => {
    const btn = e.eligible
      ? `<button onclick="printDocket('${e.exam_type}')">Print</button>`
      : `<span style='color:red'>Please visit Retentions Office</span>`;
    html += `<tr><td>${e.exam_type}</td><td>${e.eligible ? "Eligible" : "Not Eligible"}</td><td>${btn}</td></tr>`;
  });
  html += "</table>";
  document.getElementById("docketSection").innerHTML = html;
}

async function printDocket(exam_type) {
  const student_id = localStorage.getItem("student_id");
  const res = await fetch("http://127.0.0.1:5000/dockets/generate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ student_id, exam_type })
  });

  if (res.ok) {
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${exam_type}_docket.pdf`;
    a.click();
  } else {
    const json = await res.json();
    alert(json.error || "Error generating docket");
  }
}

loadDockets();
</script>
</body>
</html>

